# 9.1 支持的存储类型

|描述|PVE类型|快照|是否稳定|
|-----|-----|-----|----|
|ZFS（本地）|zfspool|是|是|

# 9.2 调度格式

复制使用日历事件(需要引用24.1)来配置计划。

# 9.3 错误处理

如果复制作业遇到问题，则会将其置于错误状态。在这种状态下，配置的复制间隔会被暂时挂起。失败的复制会以 30 分钟的间隔再次尝试。一旦成功，原始计划将再次激活。

## 9.3.1. 可能的问题

下面列出了一些最常见的问题。根据您的设置，可能还有其他原因。

- 网络不工作。

- 复制目标存储上没有可用空间。

- 目标节点上可用的具有相同存储 ID 的存储

提示：可以使用复制日志找出导致问题的原因。

## 9.3.2. 发生错误时迁移来宾

在出现严重错误的情况下，虚拟客户可能会卡在故障节点上。然后，您需要再次手动将其移动到工作节点。

## 9.3.3. 示例

假定有两个客户机（VM100和CT200）在节点A运行，并配置为复制到节点B，且A节点发生故障并无法恢复。这时可以将客户机手工迁移到节点B运行。

- 通过ssh连接到节点B，或通过WebUI打开节点B的Shell界面。

- 检查集群的投票状态
 
  `#pvecm status`

- 如果集群不具备多数票，则务必首先修复集群投票状态。只有在彻底无法修复的状态下才可以考虑用如下命令强制当前节点恢复多数票：

  `#pvecm expected 1`




警告:手工调整期望票数后，要尽一切可能避免影响集群状态的操作（如增/删节点、存储、客户机）。实际上，只应该在修复多数票或紧急启动重要客户机时才手工调整期望票数。

- 将两个客户机的配置文件从节点A复移动到节点B：
  
```
# mv /etc/pve/nodes/A/qemu-server/100.conf/etc/pve/nodes/B/qemu-server/100.conf
# mv /etc/pve/nodes/A/lxc/200.conf /etc/pve/nodes/B/lxc/200.conf
```
- 启动客户机
  
```
# qm start 100
# pct start 200
```

# 9.4 调度任务

可以在Web GUI上创建、调整或删除复制调度任务。此外，也可以使用命令行（CLI）工具pvesr管理调度任务。

在Web GUI的各层级（数据中心、节点、虚拟机）都有复制任务管理面板。不同层级的控制面板主要在于所显示的调度任务数量：所有调度任务，当前节点的调度任务或者是特定虚拟机的调度任务。

新增调度任务时，需要指定虚拟机（如果未选定的话）和目标节点。默认调度时间为每隔15分钟同步一次all 15 minutes。还可以对复制任务设置速度上限，从而避免导致存储负载过重。

复制作业由集群范围的唯一 ID 标识。此 ID 由 VMID 和作业编号组成。如果使用 CLI 工具，则必须手动指定此 ID。


# 9.5 命令行工具示例


为ID 100的虚拟机新增调度任务，每5分钟执行一次，复制带宽上限为10mbps（兆字节每秒）

```
# pvesr create-local-job 100-0 pve1 --schedule "*/5" --rate 10
```

禁用ID为100-0的调度任务

```
# pvesr disable 100-0
```

恢复被禁用的ID为100-0的调度任务

```
# pvesr enable 100-0
```

将ID为100-0的调度任务间隔修改为1小时

```
# pvesr update 100-0 --schedule ’*/00’
```
